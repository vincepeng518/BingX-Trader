<!DOCTYPE html>
<html>
<head>
    <title>BingX XAUT 馬丁機器人</title>
    <meta charset="utf-8">
    <meta http-equiv="refresh" content="6">
    <style>
        body {font-family: Consolas, monospace; background:#000; color:#0f0; padding:20px;}
        button {background:#0f0; color:#000; padding:10px 20px; margin:5px; border:none; cursor:pointer; font-weight:bold;}
        table {border-collapse: collapse; width: 100%; margin-top: 10px;}
        th, td {border: 1px solid #0f0; padding: 8px; text-align: left;}
        th {background: #003300;}
    </style>
</head>
<body>
    <h1>XAUT/USDT 強化馬丁格爾機器人</h1>
    
    <h2>即時狀態</h2>
    <p>金價：<span id="price">載入中...</span></p>
    <p>持倉：<span id="size">-</span> 張（共 <span id="count">0</span> 筆）</p>
    <p>浮動盈虧：<span id="pnl">-</span> USDT</p>
    <p>機器人：<span id="stat">載入中...</span></p>

    <hr>
    <h2>Telegram 手動控制（點即發）</h2>
    <button onclick="cmd('status')">發送 /status</button>
    <button onclick="cmd('pause')">暫停交易</button>
    <button onclick="cmd('resume')">恢復交易</button>
    <button onclick="cmd('close')">強制全平</button>

    <hr>
    <h2>最近 15 筆交易紀錄</h2>
    <table>
        <thead><tr><th>時間</th><th>動作</th></tr></thead>
        <tbody id="trades"></tbody>
    </table>

    <script>
        function cmd(action) {
            fetch(`/tg/${action}`);
            alert('已執行 /' + action);
        }

        function update() {
            fetch('/api/data')
                .then(r => r.json())
                .then(d => {
                    document.getElementById('price').innerText = Number(d.price).toFixed(2);
                    document.getElementById('size').innerText = Number(d.long_size).toFixed(6);
                    document.getElementById('count').innerText = d.entries.length;
                    document.getElementById('pnl').innerText = Number(d.total_pnl).toFixed(2);
                    document.getElementById('stat').innerText = d.status;

                    let tb = document.getElementById('trades');
                    tb.innerHTML = '';
                    // 確保 trades 是陣列（很重要！）
                    (d.trades || []).slice(-15).reverse().forEach(t => {
                        let tr = document.createElement('tr');
                        let now = new Date().toLocaleTimeString('zh-TW');
                        tr.innerHTML = `<td>${now}</td><td>${t}</td>`;
                        tb.appendChild(tr);
                    });
                })
                .catch(e => console.log("API 錯誤", e));
        }

        setInterval(update, 6000);
        update();
    update();
    </script>
</body>
</html>